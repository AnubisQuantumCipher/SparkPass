#!/usr/bin/expect -f
#
# Test password unlock (first unlock - seeds biometric cache)
#

set timeout 120
set sparkpass "./bin/sparkpass_main"
set vault "./vaults/test.spass"
set password "test_password_12345"

puts "=== Testing Password Unlock ==="
puts "Vault: $vault"
puts ""
puts "This first unlock will:"
puts "  1. Derive wrap_key using Argon2id (~2.5 seconds)"
puts "  2. Cache wrap_key in macOS Keychain"
puts "  3. Enable biometric unlock for 7 days"
puts ""

set start_time [clock seconds]

spawn $sparkpass unlock $vault
expect "Enter password: "
send "$password\r"

expect {
    "✓ password accepted" {
        set end_time [clock seconds]
        set duration [expr $end_time - $start_time]

        puts ""
        puts "✓ Password unlock successful!"
        puts "  Duration: ${duration} seconds (Argon2id KDF)"
        puts ""

        # Check if biometric cache message appears
        expect {
            "(biometric unlock enabled for 7 days)" {
                puts "✓ Biometric cache enabled!"
                puts ""
                puts "SUCCESS: Wrap key cached in Keychain with:"
                puts "  - Service: com.sparkpass.vault"
                puts "  - Account: [exec pwd]/vaults/test.spass"
                puts "  - Access Control: Touch ID/Face ID required"
                puts "  - Expiration: 7 days (604,800 seconds)"
                puts ""
                puts "Next unlock will use biometric authentication (instant)."
                puts ""
                puts "Verify cache:"
                puts "  security find-generic-password -s \"com.sparkpass.vault\" \\"
                puts "    -a \"[exec pwd]/vaults/test.spass\""
            }
            timeout {
                puts "⚠ WARNING: No biometric cache message"
                puts ""
                puts "This means the keychain cache was not enabled."
                puts "Possible reasons:"
                puts "  1. Touch ID is not enrolled (System Settings → Touch ID & Password)"
                puts "  2. Face ID not configured (M4 Macs with Face ID)"
                puts "  3. Terminal lacks keychain access permissions"
                puts "  4. Code signature changed between builds"
                puts ""
                puts "Password unlock still works, but biometric unlock unavailable."
            }
            eof {
                puts "⚠ WARNING: Process ended without cache message"
            }
        }
    }
    "✗ authentication failed" {
        puts ""
        puts "✗ Authentication failed - wrong password?"
        exit 1
    }
    "✗" {
        puts ""
        puts "✗ Unlock failed"
        exit 1
    }
    timeout {
        puts ""
        puts "✗ Unlock timed out (>120 seconds)"
        puts "  Expected: ~2.5 seconds for Argon2id"
        exit 1
    }
}

wait
